<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; padding-top: 80px; color: #1e293b; overflow-x: hidden; }
        .header { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #e2e8f0; z-index: 100; }
        
        .nav-pills .nav-link { border-radius: 50px; padding: 8px 20px; font-weight: 600; color: #64748b; margin-right: 10px; }
        .nav-pills .nav-link.active { background-color: #0f172a; color: white; }
        
        /* PIPELINE */
        .pipeline-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; height: calc(100vh - 160px); }
        .pipeline-col { flex: 0 0 300px; background: #f1f5f9; border-radius: 12px; display: flex; flex-direction: column; max-height: 100%; border: 1px solid #e2e8f0; }
        .pipeline-head { padding: 15px; font-weight: 700; color: #475569; border-bottom: 1px solid #e2e8f0; background: #fff; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; }
        .card-lead { background: white; margin: 10px; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
        .card-lead:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-color: #3b82f6; }

        /* DATABASE LIST */
        .client-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .client-item:hover { border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .avatar-initial { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 15px; font-size: 18px; }
        
        .type-corp { background: #dbeafe; color: #1e40af; } /* Biru untuk PT */
        .type-indi { background: #f3e8ff; color: #7e22ce; } /* Ungu untuk Individu */
        
        .badge-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; margin-left: 5px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="header">
        <div><h5 class="fw-bold mb-0">üë• CRM & Klien</h5><small class="text-muted">Pipeline & Database</small></div>
        <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="smartAdd()">
            <i class="fas fa-plus me-2"></i> Tambah Data
        </button>
    </div>

    <div class="container-fluid mt-2">
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="tab-pipeline" data-bs-toggle="pill" data-bs-target="#content-pipeline" type="button" onclick="currentTab='pipeline'">
                    <i class="fas fa-columns me-2"></i> Pipeline
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-database" data-bs-toggle="pill" data-bs-target="#content-database" type="button" onclick="currentTab='database'">
                    <i class="fas fa-address-book me-2"></i> Database Invoice
                </button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="content-pipeline">
                <div class="pipeline-container">
                    <div class="pipeline-col"><div class="pipeline-head"><span>NEW LEADS</span> <span class="badge bg-secondary" id="count-new">0</span></div><div class="p-2 overflow-auto h-100" id="list-new"></div></div>
                    <div class="pipeline-col"><div class="pipeline-head"><span>QUALIFIED</span> <span class="badge bg-primary" id="count-qualified">0</span></div><div class="p-2 overflow-auto h-100" id="list-qualified"></div></div>
                    <div class="pipeline-col"><div class="pipeline-head"><span>PROPOSITION</span> <span class="badge bg-info text-white" id="count-prop">0</span></div><div class="p-2 overflow-auto h-100" id="list-prop"></div></div>
                    <div class="pipeline-col"><div class="pipeline-head"><span>WON</span> <span class="badge bg-success" id="count-won">0</span></div><div class="p-2 overflow-auto h-100" id="list-won"></div></div>
                </div>
            </div>

            <div class="tab-pane fade" id="content-database">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <input type="text" class="form-control mb-3" placeholder="Cari nama klien..." oninput="searchClient(this.value)">
                        <div id="client-list-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function getDB() { return window.parent.MIJ_DB ? window.parent.MIJ_DB.getAllData() : JSON.parse(localStorage.getItem('MIJ_ERP_v2') || '{}'); }
        function saveDB(data) { window.parent.MIJ_DB ? window.parent.MIJ_DB.saveData(data) : localStorage.setItem('MIJ_ERP_v2', JSON.stringify(data)); }
        const UI = window.parent.ShowAlert;
        
        let currentTab = 'pipeline';

        function smartAdd() {
            if(currentTab === 'pipeline') addNewOpp();
            else addNewClient();
        }

        // === PIPELINE LOGIC ===
        async function addNewOpp() {
            const { value: formValues } = await window.parent.Swal.fire({
                title: 'New Opportunity',
                html: `<div class="text-start mt-2"><div class="form-floating mb-2"><input id="swal-name" class="form-control" placeholder="Name"><label>Nama Prospek</label></div><div class="form-floating mb-2"><input type="number" id="swal-val" class="form-control"><label>Potensi Nilai (RM)</label></div><div class="form-floating"><select id="swal-prio" class="form-select"><option>Low</option><option selected>Medium</option><option>High</option></select><label>Prioritas</label></div></div>`,
                confirmButtonText: 'Simpan', showCancelButton: true,
                preConfirm: () => { const doc = window.parent.document; return { name: doc.getElementById('swal-name').value, val: doc.getElementById('swal-val').value, prio: doc.getElementById('swal-prio').value } }
            });
            if(formValues && formValues.name) {
                let db = getDB(); if(!db.leads) db.leads = [];
                db.leads.push({ id: Date.now(), name: formValues.name, value: Number(formValues.val), priority: formValues.prio, stage: 'new', date: new Date().toISOString().split('T')[0] });
                saveDB(db); renderPipeline(); UI.toast('success', 'Lead Added');
            }
        }

        // Fungsi Render Kanban Board (Wajib Ada)
        function renderPipeline() {
            const db = getDB();
            const stages = ['new', 'qualified', 'prop', 'won'];
            
            stages.forEach(s => {
                // 1. Bersihkan kolom lama
                const container = document.getElementById('list-' + s);
                const counter = document.getElementById('count-' + s);
                
                if (container) container.innerHTML = '';
                
                // 2. Ambil Leads yang sesuai Stage DAN Tidak Dihapus (!deleted)
                // Filter inilah yang bikin fitur "Hapus di HP 1 = Hapus di HP 2" jalan
                const filtered = (db.leads || []).filter(l => l.stage === s && !l.deleted);
                
                // 3. Update Angka Badge
                if (counter) counter.innerText = filtered.length;
                
                // 4. Render Kartu Lead
                filtered.forEach(l => {
                    let badgeColor = l.priority === 'High' ? 'bg-danger' : (l.priority === 'Medium' ? 'bg-warning text-dark' : 'bg-secondary');
                    
                    // HTML Kartu Lead
                    container.innerHTML += `
                        <div class="card-lead" onclick="moveLead(${l.id}, '${s}')">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="badge ${badgeColor}" style="font-size:10px">${l.priority}</span>
                                <small class="text-muted" style="font-size:10px">${l.date}</small>
                            </div>
                            <h6 class="fw-bold mb-1">${l.name}</h6>
                            <small class="text-primary fw-bold">RM ${(l.value||0).toLocaleString()}</small>
                        </div>`;
                });
            });
        }

        async function moveLead(id, currentStage) {
            const nextMap = { 'new': 'qualified', 'qualified': 'prop', 'prop': 'won', 'won': 'won' };
            const nextStage = nextMap[currentStage];
            
            // Tanya user: Mau Geser (Next) atau Hapus?
            const { isConfirmed, isDenied } = await window.parent.Swal.fire({
                title: 'Update Status',
                text: 'Geser ke tahap selanjutnya?',
                showDenyButton: true, 
                showCancelButton: true,
                confirmButtonText: `Move to ${nextStage.toUpperCase()}`,
                denyButtonText: 'Hapus Lead', // Tombol Hapus
                cancelButtonText: 'Batal'
            });

            let db = getDB();
            let lead = db.leads.find(l => l.id == id);

            if (isConfirmed && lead) {
                // --- LOGIKA GESER STATUS (MOVE) ---
                lead.stage = nextStage;
                
                // Jika WON (Deal), tawarkan simpan ke Database Client
                if (nextStage === 'won' && currentStage !== 'won') {
                    saveDB(db); renderPipeline();
                    window.parent.Swal.fire({
                        title: 'Deal Won! üéâ', text: 'Simpan sebagai Klien Tetap agar bisa dibuatkan Invoice?',
                        icon: 'success', showCancelButton: true, confirmButtonText: 'Ya, Simpan ke DB'
                    }).then((res) => {
                        if(res.isConfirmed) {
                             if(!db.clients) db.clients = [];
                             // Cek duplikat nama
                             if(!db.clients.find(c => c.name === lead.name)) {
                                 db.clients.push({ 
                                     id: Date.now(), 
                                     name: lead.name, company: '-', email: '-', phone: '-',
                                     type: 'Individu',
                                     updated_at: new Date().toISOString(), // Penting buat Sync
                                     deleted: false 
                                 });
                                 saveDB(db); renderDatabase();
                                 UI.toast('success', 'Tersimpan di Database Klien!');
                             }
                        }
                    });
                } else {
                    saveDB(db); renderPipeline();
                }

            } else if (isDenied && lead) {
                // --- LOGIKA HAPUS (SOFT DELETE) ---
                // DULU: db.leads = db.leads.filter(...) -> INI SALAH (Hapus Permanen)
                
                // SEKARANG (BENAR): Tandai deleted = true
                lead.deleted = true;
                
                saveDB(db); 
                renderPipeline(); // Refresh tampilan (data sampah akan hilang krn difilter di render)
                UI.toast('info', 'Lead dihapus.');
            }
        }

        // === DATABASE CLIENT LOGIC (PEMBARUAN DISINI) ===
        async function addNewClient() {
            const { value: formValues } = await window.parent.Swal.fire({
                title: 'Tambah Klien',
                html: `
                    <div class="text-start mt-2">
                        <div class="form-floating mb-3">
                            <select id="cl-type" class="form-select fw-bold">
                                <option value="Perusahaan">üè¢ Perusahaan (Corporate)</option>
                                <option value="Individu">üë§ Individu (Personal)</option>
                            </select>
                            <label>Tipe Klien</label>
                        </div>
                        <div class="form-floating mb-2"><input id="cl-name" class="form-control" placeholder="Name"><label>Nama Kontak / PIC</label></div>
                        <div class="form-floating mb-2"><input id="cl-comp" class="form-control" placeholder="Comp"><label>Nama Perusahaan (Opsional)</label></div>
                        <div class="row g-2">
                            <div class="col-6"><div class="form-floating"><input id="cl-email" class="form-control" placeholder="@"><label>Email</label></div></div>
                            <div class="col-6"><div class="form-floating"><input id="cl-phone" class="form-control" placeholder="08"><label>Telepon</label></div></div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Simpan Data', showCancelButton: true,
                preConfirm: () => { 
                    const doc = window.parent.document; 
                    return { 
                        type: doc.getElementById('cl-type').value,
                        name: doc.getElementById('cl-name').value, 
                        company: doc.getElementById('cl-comp').value || '-',
                        email: doc.getElementById('cl-email').value,
                        phone: doc.getElementById('cl-phone').value
                    } 
                }
            });

            if(formValues && formValues.name) {
                let db = getDB();
                if(!db.clients) db.clients = [];
                
                // --- UPDATE DISINI ---
                db.clients.push({ 
                    id: Date.now(), 
                    ...formValues,
                    updated_at: new Date().toISOString(), // Tambahan Jam
                    deleted: false                        // Tambahan Status
                });
                
                saveDB(db); renderDatabase(); UI.toast('success', 'Tersimpan!');
            }
        }
        

        function renderDatabase() {
            const db = getDB();
            // FILTER: Hanya tampilkan yang deleted != true
            const clients = (db.clients || []).filter(c => !c.deleted).slice().reverse();
            const container = document.getElementById('client-list-container');
            container.innerHTML = '';

            if(clients.length === 0) { container.innerHTML = `<div class="text-center text-muted py-5">Belum ada data.<br>Klik Tambah Data.</div>`; return; }

            clients.forEach(c => {
                let isCorp = c.type === 'Perusahaan';
                let iconClass = isCorp ? 'type-corp' : 'type-indi';
                let iconSymbol = isCorp ? '<i class="fas fa-building"></i>' : '<i class="fas fa-user"></i>';
                let subtext = isCorp ? c.company : 'Personal Client';

                container.innerHTML += `
                    <div class="client-item">
                        <div class="d-flex align-items-center">
                            <div class="avatar-initial ${iconClass}">${iconSymbol}</div>
                            <div>
                                <h6 class="fw-bold mb-0">${c.name} <span class="badge-type text-muted border">${c.type||'Individu'}</span></h6>
                                <small class="text-muted">${subtext} ‚Ä¢ ${c.phone || '-'}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteClient(${c.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }

        function deleteClient(id) {
            UI.confirm('Hapus Klien?', 'Data akan hilang di semua perangkat setelah Sync.', () => {
                let db = getDB();
                
                // SMART DELETE: Jangan di-splice/buang!
                // Cari data, tandai deleted = true, update jam-nya
                let target = db.clients.find(c => c.id == id);
                if (target) {
                    target.deleted = true; 
                    target.updated_at = new Date().toISOString();
                }
                
                saveDB(db); renderDatabase();
                UI.toast('success', 'Ditandai hapus. Klik Sync untuk memproses.');
            });
        }
        
        function searchClient(keyword) {
            const term = keyword.toLowerCase();
            document.querySelectorAll('.client-item').forEach(item => {
                item.style.display = item.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', () => { renderPipeline(); renderDatabase(); });
    </script>
</body>
</html>