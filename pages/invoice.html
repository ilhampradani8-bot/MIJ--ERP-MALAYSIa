<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; padding-top: 80px; padding-bottom: 30px; color: #1e293b; }
        .header { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #e2e8f0; z-index: 100; }
        .inv-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e2e8f0; position: relative; transition: 0.2s; cursor: pointer; }
        .inv-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px -5px rgba(0,0,0,0.1); border-color: #3b82f6; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .st-paid { background: #dcfce7; color: #15803d; } .st-unpaid { background: #fee2e2; color: #b91c1c; } .st-partial { background: #fef3c7; color: #b45309; }
        
        #editor-layer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f8fafc; z-index: 200; overflow-y: auto; display: none; padding-bottom: 50px; }
        .editor-header { background: white; border-bottom: 1px solid #e2e8f0; padding: 15px 20px; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .editor-body { padding: 20px; max-width: 900px; margin: 0 auto; }
        .form-section { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .table-editor th { font-size: 11px; text-transform: uppercase; color: #64748b; background: #f8fafc; padding: 10px; }
        .table-editor input { border: 1px solid transparent; background: transparent; width: 100%; padding: 5px; font-size: 14px; }
        .table-editor input:focus { border-bottom: 1px solid #3b82f6; outline: none; background: #fff; }

        /* PDF TEMPLATE */
        #pdf-template { display: none; width: 700px; background: white; padding: 40px; font-family: 'Inter', sans-serif; color: #000; font-size: 13px; }
        .pdf-header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; margin-top: 20px; }
        .pdf-table th { background: #f1f5f9; padding: 8px; text-align: left; font-weight: bold; border-bottom: 1px solid #000; font-size: 11px; text-transform: uppercase; }
        .pdf-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
        .no-break { page-break-inside: avoid; }
    </style>
</head>
<body>

    <div class="header">
        <div><h5 class="fw-bold mb-0">ðŸ“ƒ Invoice Pro</h5><small class="text-muted">Kelola tagihan</small></div>
        <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="openEditor()"><i class="fas fa-plus me-2"></i> Baru</button>
    </div>

    <div class="container" id="invContainer"></div>

    <div id="editor-layer">
        <div class="editor-header">
            <h5 class="fw-bold mb-0"><i class="fas fa-edit me-2"></i> Editor Invoice</h5>
            <div>
                <button class="btn btn-light border me-2" onclick="closeEditor()">Batal</button>
                <button class="btn btn-primary fw-bold px-4" onclick="saveInvoice()">Simpan</button>
            </div>
        </div>
        <div class="editor-body">
            <div class="form-section">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="small fw-bold text-muted">KLIEN (Ketik untuk cari)</label>
                        <input class="form-control" list="client-options" id="inp-client" placeholder="Mulai ketik nama...">
                        <datalist id="client-options">
                            </datalist>
                    </div>
                    
                    <div class="col-md-3"><label class="small fw-bold text-muted">TERBIT</label><input type="date" id="inp-date" class="form-control"></div>
                    <div class="col-md-3"><label class="small fw-bold text-muted">JATUH TEMPO</label><input type="date" id="inp-due" class="form-control"></div>
                </div>
            </div>

            <div class="form-section p-0 overflow-hidden">
                <table class="table table-editor mb-0">
                    <thead><tr><th width="40%">Deskripsi</th><th width="15%" class="text-center">Qty</th><th width="20%" class="text-end">Harga</th><th width="20%" class="text-end">Total</th><th width="5%"></th></tr></thead>
                    <tbody id="item-list"></tbody>
                </table>
                <div class="p-3 bg-light border-top">
                    <button class="btn btn-sm btn-outline-primary fw-bold" onclick="addItemRow()"><i class="fas fa-plus me-1"></i> Tambah Item</button>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-section"><label class="small fw-bold text-muted">CATATAN</label><textarea id="inp-notes" class="form-control border-0 bg-light" rows="3"></textarea></div>
                </div>
                <div class="col-md-6">
                    <div class="form-section">
                        <div class="d-flex justify-content-between mb-2"><span class="text-muted">Subtotal</span><span class="fw-bold" id="lbl-subtotal">0</span></div>
                        <div class="d-flex justify-content-between mb-3"><span>Tax / Adj</span><input type="number" id="inp-tax" class="form-control form-control-sm text-end" style="width:100px" placeholder="0" oninput="calculateGrandTotal()"></div>
                        <hr>
                        <div class="d-flex justify-content-between"><h5 class="fw-bold">TOTAL</h5><h4 class="fw-bold text-primary mb-0" id="lbl-grand">0</h4></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="wrapper-pdf" style="position: absolute; left: -9999px;">
        <div id="pdf-template">
            <div class="pdf-header no-break">
                <div class="d-flex align-items-center">
                    <img src="../mij.png" style="height: 70px; width: auto; margin-right: 20px;" onerror="this.style.display='none'">
                    <div>
                        <div class="fw-bold fs-5 text-uppercase" id="pdf-comp-name">MY COMPANY</div>
                        <div class="small text-muted" id="pdf-comp-addr">Address Line 1</div>
                        <div class="small text-muted" id="pdf-comp-contact">Phone | Email</div>
                    </div>
                </div>
                <div class="text-end"><div style="font-size: 32px; font-weight: 800; color: #2563eb;">INVOICE</div><div id="pdf-no" class="fw-bold fs-5">#INV-000</div></div>
            </div>
            <div class="row mb-4 no-break">
                <div class="col-7"><small class="text-muted fw-bold">TAGIHAN KEPADA:</small><br><strong class="fs-6" id="pdf-client">Client Name</strong><br><span id="pdf-company">Company Name</span></div>
                <div class="col-5 text-end"><table style="width:100%"><tr><td class="text-end text-muted small">Tanggal:</td><td class="text-end fw-bold" id="pdf-date">-</td></tr><tr><td class="text-end text-muted small">Due Date:</td><td class="text-end fw-bold" id="pdf-due">-</td></tr></table></div>
            </div>
            <table class="pdf-table"><thead><tr><th width="50%">DESKRIPSI</th><th width="10%" class="text-center">QTY</th><th width="20%" class="text-end">HARGA</th><th width="20%" class="text-end">TOTAL</th></tr></thead><tbody id="pdf-items"></tbody></table>
            <div class="row no-break">
                <div class="col-7">
                    <div class="p-3 bg-light rounded border"><small class="fw-bold text-muted">CATATAN & BANK:</small><br><span id="pdf-notes" class="small mb-2 d-block">-</span><hr style="margin: 5px 0;"><div class="small"><strong><span id="pdf-bank-name">Bank</span></strong><br>No. Rek: <strong><span id="pdf-bank-acc">000</span></strong><br>A/N: <span id="pdf-bank-holder">Name</span></div></div>
                </div>
                <div class="col-5"><table style="width:100%"><tr><td class="text-end py-1">Subtotal:</td><td class="text-end fw-bold py-1" id="pdf-sub">0</td></tr><tr><td class="text-end py-1">Tax/Adj:</td><td class="text-end fw-bold py-1" id="pdf-tax">0</td></tr><tr><td class="text-end py-1 text-success">Sudah Bayar:</td><td class="text-end fw-bold py-1 text-success" id="pdf-paid">0</td></tr><tr style="border-top: 2px solid #000; font-size: 16px;"><td class="text-end fw-bold pt-2">SISA TAGIHAN:</td><td class="text-end fw-bold pt-2 text-primary" id="pdf-grand">0</td></tr></table></div>
            </div>
            <div class="mt-5 text-center text-muted small no-break"><p>Terima kasih atas kepercayaan Anda.</p></div>
        </div>
    </div>

    <script>
        function getDB() { return window.parent.MIJ_DB ? window.parent.MIJ_DB.getAllData() : JSON.parse(localStorage.getItem('MIJ_ERP_v2') || '{}'); }
        function saveDB(data) { window.parent.MIJ_DB ? window.parent.MIJ_DB.saveData(data) : localStorage.setItem('MIJ_ERP_v2', JSON.stringify(data)); }
        const UI = window.parent.ShowAlert;

        let currentInvId = null;
        let itemList = []; 

        function render() {
            const db = getDB();
            const list = document.getElementById('invContainer');
            list.innerHTML = '';

            // FILTER FINAL: Hanya ambil yang deleted = false (atau undefined)
            const invoices = (db.invoices || []).filter(i => !i.deleted).slice().reverse();

            if(invoices.length === 0) { 
                list.innerHTML = `<div class="text-center text-muted py-5">Belum ada invoice.<br><small>Klik 'Baru' untuk membuat.</small></div>`; 
                return; 
            }

            invoices.forEach(inv => {
                let stClass = inv.status === 'Paid' ? 'st-paid' : (inv.status === 'Partial' ? 'st-partial' : 'st-unpaid');
                // Kita tambah tombol sampah kecil di pojok kanan (biar cepat hapus)
                list.innerHTML += `
                    <div class="inv-card position-relative" onclick="showOptions(${inv.id})">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold small text-muted">${inv.no}</span>
                            <span class="status-badge ${stClass}">${inv.status}</span>
                        </div>
                        <h5 class="fw-bold mb-1">RM ${Number(inv.grandTotal).toLocaleString()}</h5>
                        <div class="text-muted small">${inv.clientName}</div>
                    </div>`;
            });
        }
        

        // === FUNGSI OPEN EDITOR (PERBAIKAN SEARCH KLIEN) ===
        function openEditor(id = null) {
            const db = getDB();
            const clients = db.clients || [];

            // 1. Cek Ketersediaan Data Klien
            if(clients.length === 0) {
                window.parent.Swal.fire({
                    icon: 'warning',
                    title: 'Database Klien Kosong',
                    text: 'Silahkan ke menu CRM > Tab Database Invoice untuk menambah klien dulu.',
                    confirmButtonText: 'Oke, Paham'
                });
                return;
            }
            
            // 2. Isi Datalist untuk Pencarian
            const dl = document.getElementById('client-options');
            dl.innerHTML = clients.map(c => `<option value="${c.name}"></option>`).join('');
            
            document.getElementById('editor-layer').style.display = 'block';
            currentInvId = id;

            if (id) {
                const inv = db.invoices.find(i => i.id == id);
                document.getElementById('inp-client').value = inv.clientName;
                document.getElementById('inp-date').value = inv.date;
                document.getElementById('inp-due').value = inv.dueDate || inv.date;
                document.getElementById('inp-notes').value = inv.notes || '';
                document.getElementById('inp-tax').value = inv.tax || 0;
                itemList = inv.items || [{ desc: inv.description, qty: 1, price: inv.grandTotal }];
            } else {
                document.getElementById('inp-client').value = ''; 
                document.getElementById('inp-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('inp-due').value = new Date().toISOString().split('T')[0];
                document.getElementById('inp-tax').value = 0; document.getElementById('inp-notes').value = '';
                itemList = [{ desc: '', qty: 1, price: 0 }];
            }
            renderRows();
        }

        function closeEditor() { document.getElementById('editor-layer').style.display = 'none'; }
        
        function renderRows() {
            const tbody = document.getElementById('item-list');
            tbody.innerHTML = '';
            itemList.forEach((item, index) => {
                tbody.innerHTML += `<tr><td><input type="text" value="${item.desc}" oninput="updateItem(${index}, 'desc', this.value)"></td><td><input type="number" class="text-center" value="${item.qty}" oninput="updateItem(${index}, 'qty', this.value)"></td><td><input type="number" class="text-end" value="${item.price}" oninput="updateItem(${index}, 'price', this.value)"></td><td class="text-end fw-bold pe-3" id="row-total-${index}">${(item.qty * item.price).toLocaleString()}</td><td class="text-center"><i class="fas fa-times btn-trash" onclick="deleteItem(${index})"></i></td></tr>`;
            });
            calculateGrandTotal();
        }
        function updateItem(index, field, value) {
            if (field === 'qty' || field === 'price') value = Number(value);
            itemList[index][field] = value;
            const totalEl = document.getElementById(`row-total-${index}`);
            if(totalEl) totalEl.innerText = (itemList[index].qty * itemList[index].price).toLocaleString();
            calculateGrandTotal();
        }
        function addItemRow() { itemList.push({ desc: '', qty: 1, price: 0 }); renderRows(); }
        function deleteItem(index) { if(itemList.length > 1) { itemList.splice(index, 1); renderRows(); } }
        function calculateGrandTotal() {
            let subtotal = itemList.reduce((sum, item) => sum + (item.qty * item.price), 0);
            let tax = Number(document.getElementById('inp-tax').value) || 0;
            document.getElementById('lbl-subtotal').innerText = subtotal.toLocaleString();
            document.getElementById('lbl-grand').innerText = 'RM ' + (subtotal + tax).toLocaleString();
        }
      
      function saveInvoice() {
            const clientName = document.getElementById('inp-client').value;
            if(!clientName) { UI.error('Gagal', 'Pilih Klien!'); return; }
            
            const date = document.getElementById('inp-date').value;
            const dueDate = document.getElementById('inp-due').value;
            const notes = document.getElementById('inp-notes').value;
            const tax = Number(document.getElementById('inp-tax').value);
            let validItems = itemList.filter(i => i.desc.trim() !== '');
            if(validItems.length === 0) { UI.error('Gagal', 'Isi minimal 1 baris'); return; }

            let subtotal = validItems.reduce((sum, i) => sum + (i.qty * i.price), 0);
            let grandTotal = subtotal + tax;
            let db = getDB();
            
            // --- INI BAGIAN PENTINGNYA ---
            const newData = { 
                id: currentInvId || Date.now(), 
                no: currentInvId ? db.invoices.find(i=>i.id==currentInvId).no : `INV/${new Date().getFullYear()}/${String((db.invoices||[]).length+1).padStart(3,'0')}`, 
                clientName, date, dueDate, notes, items: validItems, tax, grandTotal, 
                paidAmount: currentInvId ? db.invoices.find(i=>i.id==currentInvId).paidAmount : 0,
                
                // KITA TAMBAHKAN 2 BARIS INI:
                updated_at: new Date().toISOString(),  // Mencatat jam edit
                deleted: false                         // Menandai data ini aktif (bukan sampah)
            };
            // -----------------------------

            newData.status = (newData.grandTotal - newData.paidAmount) <= 0.1 ? 'Paid' : (newData.paidAmount > 0 ? 'Partial' : 'Unpaid');
            
            if (currentInvId) { 
                let idx = db.invoices.findIndex(i => i.id == currentInvId); 
                db.invoices[idx] = { ...db.invoices[idx], ...newData }; 
            } else { 
                db.invoices.push(newData); 
            }
            saveDB(db); closeEditor(); render(); UI.toast('success', 'Tersimpan!');
        }
        
function showOptions(id) {
            window.parent.Swal.fire({
                title: 'Aksi Invoice',
                text: 'Pilih tindakan untuk invoice ini:',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-file-pdf"></i> PDF',
                denyButtonText: '<i class="fas fa-edit"></i> Edit',
                cancelButtonText: 'Tutup',
                // Tambahkan tombol Hapus di footer (custom HTML)
                footer: `<button class="btn btn-danger btn-sm rounded-pill px-3" onclick="document.querySelector('.swal2-container').remove(); document.querySelector('iframe').contentWindow.deleteInvoice(${id})"><i class="fas fa-trash"></i> Hapus Invoice</button>`
            }).then((result) => {
                if (result.isConfirmed) generatePDF(id);
                else if (result.isDenied) openEditor(id);
            });
        }
        
        
        function deleteInvoice(id) {
            // Konfirmasi dulu
            window.parent.ShowAlert.confirm('Hapus Invoice?', 'Data akan hilang di semua perangkat setelah Sync.', () => {
                let db = getDB();
                let target = db.invoices.find(i => i.id == id);
                
                if(target) {
                    // LOGIKA SOFT DELETE (SMART SYNC)
                    target.deleted = true; 
                    target.updated_at = new Date().toISOString(); 
                    
                    saveDB(db); 
                    render();
                    window.parent.ShowAlert.toast('success', 'Invoice dihapus (masuk antrian Sync).');
                }
            });
        }
        
        function generatePDF(id) {
            const db = getDB(); const inv = db.invoices.find(i => i.id == id); const client = (db.clients || []).find(c => c.name === inv.clientName); const set = db.settings || {};
            document.getElementById('pdf-comp-name').innerText = set.companyName || 'NAMA PERUSAHAAN';
            document.getElementById('pdf-comp-addr').innerText = set.address || '';
            document.getElementById('pdf-comp-contact').innerText = (set.phone || '') + ' | ' + (set.email || '');
            document.getElementById('pdf-no').innerText = inv.no; document.getElementById('pdf-date').innerText = inv.date; document.getElementById('pdf-due').innerText = inv.dueDate || inv.date;
            document.getElementById('pdf-client').innerText = inv.clientName; document.getElementById('pdf-company').innerText = client ? client.company : ''; document.getElementById('pdf-notes').innerText = inv.notes || '-';
            document.getElementById('pdf-bank-name').innerText = set.bankName || 'Bank Belum Diatur'; document.getElementById('pdf-bank-acc').innerText = set.bankAccount || '-'; document.getElementById('pdf-bank-holder').innerText = set.bankHolder || '-';
            const tbody = document.getElementById('pdf-items'); tbody.innerHTML = ''; let sub = 0;
            (inv.items || []).forEach(item => { let t = item.qty * item.price; sub += t; tbody.innerHTML += `<tr><td>${item.desc}</td><td class="text-center">${item.qty}</td><td class="text-end">${item.price.toLocaleString()}</td><td class="text-end fw-bold">${t.toLocaleString()}</td></tr>`; });
            let paid = inv.paidAmount || 0; let sisa = inv.grandTotal - paid;
            document.getElementById('pdf-sub').innerText = sub.toLocaleString(); document.getElementById('pdf-tax').innerText = (inv.tax||0).toLocaleString(); document.getElementById('pdf-paid').innerText = '- ' + paid.toLocaleString(); document.getElementById('pdf-grand').innerText = 'RM ' + sisa.toLocaleString();
            const el = document.getElementById('pdf-template'); el.style.display = 'block'; UI.toast('info', 'Membuat PDF...');
            html2pdf().set({ margin: [10, 10, 10, 10], filename: inv.no.replace(/\//g,'-') + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: 'avoid-all' } }).from(el).save().then(() => el.style.display = 'none');
        }
        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>