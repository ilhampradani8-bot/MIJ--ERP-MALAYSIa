<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance & Payments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .table-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .bg-gradient-success { background: linear-gradient(135deg, #198754, #157347); color: white; }
    </style>
</head>
<body>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1"><i class="fas fa-money-bill-wave me-2 text-success"></i>Keuangan</h4>
            <small class="text-muted">Riwayat Pembayaran Masuk</small>
        </div>
        <button class="btn btn-success fw-bold px-4 rounded-pill shadow-sm" onclick="addPayment()">
            <i class="fas fa-plus me-2"></i>Input Bayar
        </button>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th width="15%">Tanggal</th>
                        <th width="30%">Invoice & Klien</th>
                        <th width="20%">Metode</th>
                        <th width="25%" class="text-end">Jumlah</th>
                        <th width="10%" class="text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="payment-list">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT LOGIC ---
        
        function getDB() { return window.parent.MIJ_DB.getAllData(); }
        function saveDB(data) { window.parent.MIJ_DB.saveData(data); }

        // FUNGSI RENDER (Menampilkan Data)
        function render() {
            const db = getDB();
            const list = document.getElementById('payment-list');
            
            if(!list) return; // Mencegah error jika HTML belum siap
            list.innerHTML = ''; // Bersihkan isi lama

            // Filter data yang dihapus
            const payments = (db.payments || []).filter(p => !p.deleted).slice().reverse();

            if(payments.length === 0) {
                list.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-receipt fa-3x mb-3 text-light"></i><br>Belum ada riwayat pembayaran.</td></tr>`;
                return;
            }

            payments.forEach(p => {
                list.innerHTML += `
                    <tr>
                        <td>${p.date}</td>
                        <td>
                            <div class="fw-bold text-dark">${p.invoiceNo}</div>
                            <small class="text-muted"><i class="fas fa-user me-1"></i> ${p.clientName}</small>
                        </td>
                        <td><span class="badge bg-light text-dark border">${p.method}</span></td>
                        <td class="text-end fw-bold text-success">RM ${Number(p.amount).toLocaleString()}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="deletePayment(${p.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // FUNGSI INPUT PEMBAYARAN
        async function addPayment() {
            const db = getDB();
            // Hanya tampilkan invoice yang BELUM LUNAS dan TIDAK DIHAPUS
            const unpaidInvoices = (db.invoices || []).filter(inv => inv.status !== 'Paid' && !inv.deleted);

            if (unpaidInvoices.length === 0) { 
                window.parent.Swal.fire('Info', 'Semua Invoice sudah Lunas!', 'info'); 
                return; 
            }

            let optionsHTML = unpaidInvoices.map(inv => 
                `<option value="${inv.id}">${inv.no} - ${inv.clientName} (Sisa: RM ${(inv.grandTotal - (inv.paidAmount||0)).toLocaleString()})</option>`
            ).join('');

            const { value: formValues } = await window.parent.Swal.fire({
                title: 'Input Pembayaran',
                html: `
                    <div class="text-start mt-2">
                        <div class="form-floating mb-3"><select id="swal-inv" class="form-select">${optionsHTML}</select><label>Pilih Invoice</label></div>
                        <div class="form-floating mb-3"><input id="swal-amount" type="number" class="form-control" placeholder="Jml"><label>Jumlah Diterima (RM)</label></div>
                        <div class="form-floating"><select id="swal-method" class="form-select"><option>Bank Transfer</option><option>Cash / Tunai</option><option>QR Pay / E-Wallet</option><option>Cheque</option></select><label>Metode Pembayaran</label></div>
                    </div>
                `,
                confirmButtonText: 'Simpan', showCancelButton: true,
                preConfirm: () => { 
                    const doc = window.parent.document; 
                    return { 
                        invId: doc.getElementById('swal-inv').value, 
                        amount: doc.getElementById('swal-amount').value, 
                        method: doc.getElementById('swal-method').value 
                    } 
                }
            });

            if (formValues) {
                const { invId, amount, method } = formValues;
                if(!amount || amount <= 0) return;

                const idx = db.invoices.findIndex(i => i.id == invId);
                if(idx !== -1) {
                    const inv = db.invoices[idx];
                    
                    // Update Invoice
                    inv.paidAmount = (inv.paidAmount || 0) + Number(amount);
                    let sisa = inv.grandTotal - inv.paidAmount;
                    inv.status = sisa <= 0.1 ? 'Paid' : 'Partial'; // Update Status
                    
                    // Buat Data Payment Baru
                    if(!db.payments) db.payments = [];
                    db.payments.push({
                        id: Date.now(),
                        invoiceId: inv.id, invoiceNo: inv.no, clientName: inv.clientName,
                        amount: Number(amount), method: method, date: new Date().toISOString().split('T')[0],
                        deleted: false // Wajib untuk Supabase
                    });
                    
                    saveDB(db); render();
                    window.parent.Swal.fire({icon: 'success', title: 'Pembayaran Masuk', timer: 1500, showConfirmButton: false});
                }
            }
        }

        // FUNGSI HAPUS (Koreksi Saldo)
        function deletePayment(id) {
            window.parent.Swal.fire({
                title: 'Batalkan Pembayaran?', text: "Saldo Invoice akan dikembalikan.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Batalkan'
            }).then((result) => {
                if (result.isConfirmed) {
                    let db = getDB();
                    let payIndex = db.payments.findIndex(p => p.id == id);
                    
                    if(payIndex !== -1) {
                        let pay = db.payments[payIndex];
                        
                        // 1. Kembalikan Saldo Invoice
                        let invIndex = db.invoices.findIndex(i => i.id == pay.invoiceId);
                        if(invIndex !== -1) {
                            let inv = db.invoices[invIndex];
                            inv.paidAmount = (inv.paidAmount || 0) - pay.amount;
                            if(inv.paidAmount < 0) inv.paidAmount = 0;
                            // Reset status
                            inv.status = (inv.paidAmount > 0) ? 'Partial' : 'Unpaid';
                        }

                        // 2. Hapus Payment (Soft Delete)
                        pay.deleted = true;
                        
                        saveDB(db); render();
                        window.parent.Swal.fire({icon: 'success', title: 'Dibatalkan', timer: 1000, showConfirmButton: false});
                    }
                }
            });
        }

        // Init
        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>