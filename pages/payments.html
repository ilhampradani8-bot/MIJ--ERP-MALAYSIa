<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments & Receipts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* STYLE SAMA SEPERTI SEBELUMNYA */
        body { background-color: #f4f6f8; font-family: 'Segoe UI', Roboto, sans-serif; padding: 25px; padding-bottom: 100px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-weight: 700; color: #1e293b; letter-spacing: -0.5px; margin: 0; }
        .text-sub { color: #64748b; font-size: 0.9rem; }
        .card-table { background: white; border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); overflow: hidden; }
        .table { margin-bottom: 0; }
        .table thead th { background-color: #f8fafc; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; padding: 15px 20px; border-bottom: 1px solid #e2e8f0; }
        .table tbody td { padding: 16px 20px; vertical-align: middle; color: #334155; font-size: 0.95rem; border-bottom: 1px solid #f1f5f9; }
        .badge-method { background: #e0f2fe; color: #0284c7; padding: 5px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; }
        .amount-text { font-family: 'Consolas', monospace; font-weight: 700; color: #059669; }
        .btn-action { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: 0.2s; border: none; }
        .btn-print { background: #eff6ff; color: #3b82f6; margin-right: 5px; }
        .btn-print:hover { background: #2563eb; color: white; }
        .btn-del { background: #fef2f2; color: #ef4444; }
        .btn-del:hover { background: #dc2626; color: white; }
        .btn-add { background: #0f172a; color: white; border-radius: 10px; padding: 10px 20px; font-weight: 600; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); border: none; transition: 0.2s; }
        .btn-add:hover { background: #334155; transform: translateY(-2px); }
    </style>
</head>
<body>

    <div class="page-header">
        <div>
            <h3 class="page-title">Financial Records</h3>
            <span class="text-sub">Riwayat pembayaran masuk & Kwitansi</span>
        </div>
        <button class="btn-add" onclick="addPayment()">
            <i class="fas fa-plus me-2"></i>New Payment
        </button>
    </div>

    <div class="card-table">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Invoice / Client</th>
                        <th>Method</th>
                        <th class="text-end">Amount (RM)</th>
                        <th class="text-center">Receipt</th>
                    </tr>
                </thead>
                <tbody id="payment-list">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        function getDB() { return window.parent.MIJ_DB.getAllData(); }
        function saveDB(data) { window.parent.MIJ_DB.saveData(data); }

        // --- RENDER DATA ---
        function render() {
            const db = getDB();
            const list = document.getElementById('payment-list');
            list.innerHTML = ''; 
            const payments = (db.payments || []).filter(p => !p.deleted).slice().reverse();

            if(payments.length === 0) {
                list.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">No payment records found.</td></tr>`;
                return;
            }

            payments.forEach(p => {
                list.innerHTML += `
                    <tr>
                        <td><span class="fw-bold text-dark">${p.date}</span></td>
                        <td><div class="fw-bold text-dark" style="font-size:0.9rem">${p.invoiceNo}</div><small class="text-muted">${p.clientName}</small></td>
                        <td><span class="badge-method">${p.method}</span></td>
                        <td class="text-end amount-text">RM ${Number(p.amount).toLocaleString()}</td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center">
                                <button class="btn-action btn-print" onclick="printReceipt(${p.id})" title="Download PDF"><i class="fas fa-print"></i></button>
                                <button class="btn-action btn-del" onclick="deletePayment(${p.id})" title="Void"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // =========================================
        // FITUR DOWNLOAD PDF DENGAN AUTO-LOAD GAMBAR
        // =========================================
        
        // Fungsi Helper: Mengambil gambar dari URL dan ubah jadi data yang bisa dibaca PDF
        function getBase64ImageFromURL(url) {
            return new Promise((resolve, reject) => {
                var img = new Image();
                img.setAttribute("crossOrigin", "anonymous");
                img.onload = () => {
                    var canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    var dataURL = canvas.toDataURL("image/png");
                    resolve(dataURL);
                };
                img.onerror = error => reject(error);
                // Asumsi: mij.png ada di folder root (satu level di atas folder pages)
                img.src = url; 
            });
        }

        // Fungsi Print Utama (Sekarang Async)
        async function printReceipt(id) {
            const { jsPDF } = window.jspdf;
            const db = getDB();
            const pay = db.payments.find(p => p.id == id);
            const settings = db.settings || {};
            if(!pay) return;

            // Tampilkan loading sebentar karena proses ambil gambar butuh waktu
            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: [80, 130] });
            let y = 10;

            // --- 1. LOAD LOGO OTOMATIS ---
            try {
                // Mencari file mij.png di folder induk (../)
                const logoData = await getBase64ImageFromURL('../mij.png');
                // addImage(data, format, x, y, width, height) -> height 0 artinya otomatis proporsional
                doc.addImage(logoData, 'PNG', 27.5, y, 25, 0); 
                y += 25; // Geser posisi teks ke bawah setelah logo
            } catch (e) {
                console.warn("Logo mij.png tidak ditemukan atau gagal dimuat. PDF akan dibuat tanpa logo.");
                // Lanjut tanpa logo, cuma geser dikit
                y += 5;
            }

            // --- 2. HEADER ---
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text(settings.companyName || "MIJ DIGITAL", 40, y, { align: "center" });
            y += 5;
            
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            doc.text(settings.address || "Digital Solutions Provider", 40, y, { align: "center" });
            y += 4;
            doc.text("----------------------------------------------------------------", 40, y, { align: "center" });
            y += 6;

            // --- 3. JUDUL & DETAIL ---
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("OFFICIAL RECEIPT", 40, y, { align: "center" });
            y += 10;

            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            const addLine = (label, value) => {
                doc.text(label, 5, y);
                doc.text(": " + value, 30, y);
                y += 5;
            };

            addLine("Receipt No", "#PAY-" + String(pay.id).slice(-4));
            addLine("Date", pay.date);
            addLine("Invoice Ref", pay.invoiceNo);
            let clientNameShort = pay.clientName.length > 22 ? pay.clientName.substring(0, 22) + "..." : pay.clientName;
            addLine("Received From", clientNameShort);
            addLine("Method", pay.method);
            
            y += 2;
            doc.text("----------------------------------------------------------------", 40, y, { align: "center" });
            
            // --- 4. TOTAL & FOOTER ---
            y += 8;
            doc.setFontSize(13);
            doc.setFont("helvetica", "bold");
            doc.text("TOTAL: RM " + Number(pay.amount).toLocaleString(), 40, y, { align: "center" });
            
            y += 15;
            doc.setFontSize(7);
            doc.setFont("helvetica", "italic");
            doc.text("Paid in Full. Thank You.", 40, y, { align: "center" });
            doc.text("Generated by MIJ System", 40, y+4, { align: "center" });

            // --- 5. SAVE & RESET TOMBOL ---
            doc.save(`Receipt-${pay.invoiceNo}.pdf`);
            
            // Kembalikan tombol seperti semula
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }

        // --- FUNGSI TAMBAH & HAPUS (Tetap sama) ---
        async function addPayment() {
            const db = getDB();
            const unpaidInvoices = (db.invoices || []).filter(inv => inv.status !== 'Paid' && !inv.deleted);
            if (unpaidInvoices.length === 0) { window.parent.Swal.fire('All Paid', 'Semua Invoice sudah lunas.', 'info'); return; }
            let optionsHTML = unpaidInvoices.map(inv => `<option value="${inv.id}">${inv.no} - ${inv.clientName} (Sisa: RM ${(inv.grandTotal - (inv.paidAmount||0)).toLocaleString()})</option>`).join('');
            const { value: formValues } = await window.parent.Swal.fire({
                title: 'New Payment',
                html: `<div class="text-start mt-2"><div class="mb-2"><small>Select Invoice</small><select id="swal-inv" class="form-select">${optionsHTML}</select></div><div class="mb-2"><small>Amount (RM)</small><input id="swal-amount" type="number" class="form-control"></div><div class="mb-2"><small>Payment Method</small><select id="swal-method" class="form-select"><option>Bank Transfer</option><option>Cash</option><option>QR Pay</option><option>Cheque</option></select></div></div>`,
                confirmButtonText: 'Submit Payment', showCancelButton: true,
                preConfirm: () => { const doc = window.parent.document; return { invId: doc.getElementById('swal-inv').value, amount: doc.getElementById('swal-amount').value, method: doc.getElementById('swal-method').value } }
            });
            if (formValues) {
                const { invId, amount, method } = formValues;
                if(!amount || amount <= 0) return;
                const idx = db.invoices.findIndex(i => i.id == invId);
                if(idx !== -1) {
                    const inv = db.invoices[idx];
                    inv.paidAmount = (inv.paidAmount || 0) + Number(amount);
                    let sisa = inv.grandTotal - inv.paidAmount;
                    inv.status = sisa <= 0.1 ? 'Paid' : 'Partial'; 
                    if(!db.payments) db.payments = [];
                    db.payments.push({ id: Date.now(), invoiceId: inv.id, invoiceNo: inv.no, clientName: inv.clientName, amount: Number(amount), method: method, date: new Date().toISOString().split('T')[0], deleted: false });
                    saveDB(db); render();
                    window.parent.Swal.fire({icon: 'success', title: 'Payment Recorded', timer: 1500, showConfirmButton: false});
                }
            }
        }
        function deletePayment(id) {
            window.parent.Swal.fire({
                title: 'Void Payment?', text: "Saldo Invoice akan dikembalikan.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, Void it'
            }).then((result) => {
                if (result.isConfirmed) {
                    let db = getDB();
                    let payIndex = db.payments.findIndex(p => p.id == id);
                    if(payIndex !== -1) {
                        let pay = db.payments[payIndex];
                        let invIndex = db.invoices.findIndex(i => i.id == pay.invoiceId);
                        if(invIndex !== -1) {
                            let inv = db.invoices[invIndex];
                            inv.paidAmount = (inv.paidAmount || 0) - pay.amount;
                            if(inv.paidAmount < 0) inv.paidAmount = 0;
                            inv.status = (inv.paidAmount > 0) ? 'Partial' : 'Unpaid';
                        }
                        pay.deleted = true;
                        saveDB(db); render();
                        window.parent.Swal.fire({icon: 'success', title: 'Payment Voided', timer: 1000, showConfirmButton: false});
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>