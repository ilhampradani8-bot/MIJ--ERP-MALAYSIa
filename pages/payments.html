<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; padding-top: 80px; color: #1e293b; }
        
        /* HEADER */
        .header { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #e2e8f0; z-index: 100; }
        
        /* BALANCE CARD */
        .balance-card {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; border-radius: 20px; padding: 30px;
            margin-bottom: 30px; box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.3); position: relative; overflow: hidden;
        }
        .balance-card::after { content: 'RM'; position: absolute; right: -20px; bottom: -40px; font-size: 140px; font-weight: 800; opacity: 0.05; }

        /* LIST STYLE */
        .pay-card {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e2e8f0;
            display: flex; align-items: center; justify-content: space-between; transition: 0.2s;
        }
        .pay-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px -3px rgba(0,0,0,0.1); border-color: #3b82f6; }
        .icon-box { width: 50px; height: 50px; border-radius: 12px; background: #f0f9ff; color: #0284c7; font-size: 20px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .btn-print { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #e2e8f0; background: white; color: #64748b; transition: 0.2s; }
        .btn-print:hover { background: #0f172a; color: white; border-color: #0f172a; }

        /* RECEIPT TEMPLATE (HIDDEN DULU) */
        #receipt-template { 
            display: none; 
            width: 750px; /* Lebar fix untuk A4 Scale */
            background: white; 
            padding: 40px; 
            color: #000; 
            font-family: 'Inter', sans-serif; 
            font-size: 14px;
            line-height: 1.5;
        }

        /* CLASSES UNTUK CEGAH POTONGAN (PAGE BREAK AVOID) */
        .no-break { page-break-inside: avoid; break-inside: avoid; }
        
        .rc-header { border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; }
        .rc-title { font-size: 28px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; color: #0f172a; margin-bottom: 5px; }
        .rc-label { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 3px; letter-spacing: 0.5px; }
        .rc-value { font-size: 16px; font-weight: 600; color: #0f172a; border-bottom: 1px dotted #cbd5e1; padding-bottom: 8px; margin-bottom: 25px; }
        .rc-amount-box { background: #f1f5f9; padding: 20px; border-radius: 8px; text-align: center; margin: 30px 0; border: 1px solid #e2e8f0; page-break-inside: avoid; }
        .rc-big-amt { font-size: 36px; font-weight: 800; color: #0f172a; }
        .rc-footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #e2e8f0; page-break-inside: avoid; }
    </style>
</head>
<body>

    <div class="header">
        <div><h5 class="fw-bold mb-0">ðŸ’° Finance</h5><small class="text-muted">Arus kas & Kwitansi</small></div>
        <button class="btn btn-dark rounded-pill px-4 fw-bold" onclick="addPayment()"><i class="fas fa-plus me-2"></i> Input Bayar</button>
    </div>

    <div class="container">
        <div class="balance-card">
            <small class="text-white-50 text-uppercase fw-bold ls-1">Total Pendapatan (Paid)</small>
            <h1 class="fw-bold mb-0 mt-2" id="totalRevenue">RM 0</h1>
            <div class="mt-3 small text-white-50"><i class="fas fa-check-circle me-2"></i>Verified System</div>
        </div>

        <h6 class="fw-bold text-muted mb-3 text-uppercase small ls-1">Riwayat Pembayaran</h6>
        <div id="paymentList"></div>
    </div>

    <div id="wrapper-rc" style="position: absolute; left: -9999px;">
        <div id="receipt-template">
            <div class="rc-header no-break">
                <div class="d-flex align-items-center">
                    <img src="../mij.png" style="height: 60px; width: auto; margin-right: 20px;" onerror="this.style.display='none'">
                    <div>
                        <div class="fw-bold fs-5" id="rc-comp-name">MIJ DIGITAL</div>
                        <div class="small text-muted" id="rc-comp-addr">Address Line</div>
                    </div>
                </div>
                <div class="text-end">
                    <div class="rc-title">RECEIPT</div>
                    <div class="text-muted fw-bold" id="rc-no">#RCP-000</div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-6 no-break">
                    <div class="rc-label">Date (Tanggal)</div>
                    <div class="rc-value" id="rc-date">-</div>
                </div>
                <div class="col-6 no-break">
                    <div class="rc-label">Payment Method (Metode)</div>
                    <div class="rc-value" id="rc-method">-</div>
                </div>
            </div>

            <div class="no-break">
                <div class="rc-label mt-2">Received From (Diterima Dari)</div>
                <div class="rc-value" id="rc-from">-</div>
            </div>

            <div class="no-break">
                <div class="rc-label mt-2">Payment For (Untuk Pembayaran)</div>
                <div class="rc-value" id="rc-desc">-</div>
            </div>

            <div class="rc-amount-box no-break">
                <div class="small text-muted fw-bold text-uppercase mb-2">Amount Received</div>
                <div class="rc-big-amt" id="rc-amount">RM 0</div>
            </div>

            <div class="rc-footer no-break">
                <div class="row">
                    <div class="col-7">
                        <small class="text-muted">
                            Thank you for your payment.<br>
                            This is a computer-generated receipt. No signature required.<br>
                            <div class="mt-2 p-2 bg-light border rounded d-inline-block">
                                <strong><span id="rc-bank-name">Bank</span>: <span id="rc-bank-acc">000</span> (<span id="rc-bank-holder">Name</span>)</strong>
                            </div>
                        </small>
                    </div>
                    <div class="col-5 text-center d-flex flex-column justify-content-end">
                        <div style="height: 60px; border-bottom: 1px solid #000; margin-bottom: 10px; width: 80%; margin-left: auto; margin-right: auto;"></div>
                        <small class="fw-bold">Authorized Signature</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getDB() { return window.parent.MIJ_DB ? window.parent.MIJ_DB.getAllData() : JSON.parse(localStorage.getItem('MIJ_ERP_v2') || '{}'); }
        function saveDB(data) { window.parent.MIJ_DB ? window.parent.MIJ_DB.saveData(data) : localStorage.setItem('MIJ_ERP_v2', JSON.stringify(data)); }
        const UI = window.parent.ShowAlert;

        function render() {
            const db = getDB();
            const payments = (db.payments || []).slice().reverse();
            let total = payments.reduce((sum, p) => sum + Number(p.amount || 0), 0);
            document.getElementById('totalRevenue').innerText = 'RM ' + total.toLocaleString();

            const list = document.getElementById('paymentList');
            list.innerHTML = '';
            
            if(payments.length === 0) { list.innerHTML = `<div class="text-center text-muted py-5">Belum ada data pembayaran</div>`; return; }

            payments.forEach(p => {
                let icon = p.method.includes('Bank') ? 'fa-university' : (p.method.includes('QR') ? 'fa-qrcode' : 'fa-money-bill-wave');
                list.innerHTML += `
                    <div class="pay-card">
                        <div class="d-flex align-items-center">
                            <div class="icon-box"><i class="fas ${icon}"></i></div>
                            <div>
                                <h6 class="fw-bold mb-0">RM ${Number(p.amount).toLocaleString()}</h6>
                                <small class="text-muted">dari ${p.invoiceNo} â€¢ ${p.date}</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn-print" onclick="showPreview(${p.id})" title="Cetak Kwitansi"><i class="fas fa-print"></i></button>
                        </div>
                    </div>`;
            });
        }

        async function addPayment() {
            const db = getDB();
            const unpaidInvoices = (db.invoices || []).filter(inv => inv.status !== 'Paid');
            if (unpaidInvoices.length === 0) { UI.toast('error', 'Semua invoice sudah lunas!'); return; }

            let optionsHTML = unpaidInvoices.map(inv => `<option value="${inv.id}">${inv.no} - ${inv.clientName} (Sisa: RM ${(inv.grandTotal - (inv.paidAmount||0)).toLocaleString()})</option>`).join('');

            const { value: formValues } = await window.parent.Swal.fire({
                title: 'Input Pembayaran',
                html: `<div class="text-start mt-2"><div class="form-floating mb-3"><select id="swal-inv" class="form-select">${optionsHTML}</select><label>Pilih Invoice</label></div><div class="form-floating mb-3"><input id="swal-amount" type="number" class="form-control" placeholder="Jml"><label>Jumlah (RM)</label></div><div class="form-floating"><select id="swal-method" class="form-select"><option>Bank Transfer</option><option>Cash / Tunai</option><option>QR Pay / E-Wallet</option><option>Cheque</option></select><label>Metode</label></div></div>`,
                confirmButtonText: 'Simpan', showCancelButton: true,
                preConfirm: () => { const doc = window.parent.document; return { invId: doc.getElementById('swal-inv').value, amount: doc.getElementById('swal-amount').value, method: doc.getElementById('swal-method').value } }
            });

            if (formValues) {
                const { invId, amount, method } = formValues;
                if(!amount || amount <= 0) return;
                const idx = db.invoices.findIndex(i => i.id == invId);
                if(idx !== -1) {
                    const inv = db.invoices[idx];
                    inv.paidAmount = (inv.paidAmount || 0) + Number(amount);
                    let sisa = inv.grandTotal - inv.paidAmount;
                    inv.status = sisa <= 0.1 ? 'Paid' : 'Partial';
                    
                    if(!db.payments) db.payments = [];
                    const newPay = { id: Date.now(), invoiceId: inv.id, invoiceNo: inv.no, clientName: inv.clientName, amount: Number(amount), method: method, date: new Date().toISOString().split('T')[0] };
                    db.payments.push(newPay);
                    saveDB(db); render();
                    showPreview(newPay.id); // Langsung preview
                }
            }
        }

        // --- PREVIEW SEBELUM PRINT ---
        function showPreview(payId) {
            prepareReceiptData(payId); // Isi data ke template tersembunyi dulu

            // Ambil HTML dari template
            const templateHtml = document.getElementById('receipt-template').innerHTML;

            // Tampilkan di SweetAlert Lebar
            window.parent.Swal.fire({
                title: 'Preview Kwitansi',
                html: `<div style="text-align:left; background:white; border:1px solid #ddd; padding:20px; border-radius:8px; max-height:60vh; overflow-y:auto;">${templateHtml}</div>`,
                width: '800px',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-file-pdf"></i> Download PDF',
                cancelButtonText: 'Tutup',
                confirmButtonColor: '#0f172a',
                customClass: { popup: 'rounded-4' }
            }).then((result) => {
                if (result.isConfirmed) {
                    downloadPDF(payId);
                }
            });
        }

        // --- FUNGSI DOWNLOAD PDF (DENGAN PAGE BREAK PROTECT) ---
        function downloadPDF(payId) {
            prepareReceiptData(payId);
            const el = document.getElementById('receipt-template');
            el.style.display = 'block'; // Munculkan sebentar

            window.parent.ShowAlert.toast('info', 'Generating PDF...');

            const opt = {
                margin:       10, // Margin aman 1cm
                filename:     `Receipt_${payId}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true }, // Scale 2 biar tajam
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }, // A4 Portrait lebih aman buat 2 lembar
                // INI KUNCINYA: Jangan potong elemen dengan class 'no-break'
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } 
            };

            html2pdf().set(opt).from(el).save().then(() => {
                el.style.display = 'none'; // Sembunyikan lagi
                window.parent.ShowAlert.toast('success', 'PDF Selesai!');
            });
        }

        function prepareReceiptData(payId) {
            const db = getDB();
            const pay = db.payments.find(p => p.id == payId);
            const set = db.settings || {};
            
            // Isi Data
            document.getElementById('rc-comp-name').innerText = set.companyName || 'MIJ DIGITAL';
            document.getElementById('rc-comp-addr').innerText = set.address || '';
            document.getElementById('rc-no').innerText = '#RCP-' + String(pay.id).slice(-6);
            document.getElementById('rc-date').innerText = pay.date;
            document.getElementById('rc-method').innerText = pay.method;
            
            // Cari nama klien
            const inv = db.invoices.find(i => i.id == pay.invoiceId);
            const clientName = pay.clientName || (inv ? inv.clientName : 'Customer');
            document.getElementById('rc-from').innerText = clientName;
            
            document.getElementById('rc-desc').innerText = `Payment for Invoice ${pay.invoiceNo}`;
            document.getElementById('rc-amount').innerText = 'RM ' + Number(pay.amount).toLocaleString();

            document.getElementById('rc-bank-name').innerText = set.bankName || 'Bank';
            document.getElementById('rc-bank-acc').innerText = set.bankAccount || '-';
            document.getElementById('rc-bank-holder').innerText = set.bankHolder || '-';
        }

        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
